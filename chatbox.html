<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Virtual Compacto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div id="ai-assistant" class="d-flex flex-column p-3 border rounded">
        <!-- Header del asistente -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Asistente Virtual</h6>
            <button id="clear-chat" class="btn btn-danger btn-sm">🗑️ Limpiar</button>
        </div>

        <!-- Contenedor principal -->
        <div class="d-flex flex-grow-1">
            <!-- Sidebar para chats guardados -->
            <div class="me-2 p-2 border rounded bg-white" style="width: 120px;">
                <h6 class="text-center" style="font-size: 0.9rem;">Chats</h6>
                <div id="saved-chats" class="mt-2">
                    <p class="text-muted text-center">Vacío</p>
                </div>
            </div>

            <!-- Contenedor del chat -->
            <div class="d-flex flex-column flex-grow-1 border rounded bg-white p-2">
                <div id="chat-body" class="flex-grow-1 mb-2 d-flex flex-column">
                    <p class="text-muted text-center">Realiza tu consulta por voz.</p>
                </div>
                <div class="d-flex align-items-center">
                    <button id="start-voice" class="btn btn-primary btn-sm me-1">🎤 Hablar</button>
                    <button id="save-chat" class="btn btn-secondary btn-sm">💾 Guardar Chat</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const startButton = document.getElementById("start-voice");
        const clearChatButton = document.getElementById("clear-chat");
        const saveChatButton = document.getElementById("save-chat");
        const chatBody = document.getElementById("chat-body");
        const savedChats = document.getElementById("saved-chats");

        const recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const synth = window.speechSynthesis;

        const GOOGLE_API_KEY = 'AIzaSyANb-3JWKBgTpLLSA5-iTSfM5Q0fRGuv2o'; // Coloca tu API Key
        const CX = '734072da802984e1d'; // Coloca tu ID CX

        let currentChat = [];

        // Verificar si el navegador soporta reconocimiento de voz
        if (!recognition) {
            alert("Tu navegador no soporta la API de reconocimiento de voz.");
        } else {
            const speechRecognition = new recognition();
            speechRecognition.lang = "es-ES";

            startButton.addEventListener("click", () => {
                addMessage("Escuchando...", "assistant");
                speechRecognition.start();
            });

            speechRecognition.onresult = async (event) => {
                const query = event.results[0][0].transcript;
                addMessage(query, "user");
                await fetchSearchResults(query);
            };
        }

        function addMessage(text, sender) {
            const bubble = document.createElement("div");
            bubble.textContent = text;
            bubble.className = `chat-bubble ${sender}`;
            chatBody.appendChild(bubble);
            currentChat.push({ sender, text });
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function fetchSearchResults(query) {
            try {
                const response = await fetch(`https://www.googleapis.com/customsearch/v1?q=${query}&key=${GOOGLE_API_KEY}&cx=${CX}`);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    const snippet = data.items[0].snippet || "No se encontró información relevante.";
                    addMessage(snippet, "assistant");
                    const speech = new SpeechSynthesisUtterance(snippet);
                    speech.lang = "es-ES";
                    synth.speak(speech);
                } else {
                    addMessage("No se encontraron resultados.", "assistant");
                }
            } catch (error) {
                addMessage("Error al realizar la búsqueda. Verifica tu conexión o configuración.", "assistant");
            }
        }

        // Limpiar chat
        clearChatButton.addEventListener("click", () => {
            chatBody.innerHTML = `<p class="text-muted text-center">Realiza tu consulta por voz.</p>`;
            currentChat = [];
        });

        // Guardar chat
        saveChatButton.addEventListener("click", () => {
            if (currentChat.length > 0) {
                const chatElement = document.createElement("div");
                chatElement.className = "saved-chat";
                chatElement.textContent = `Chat ${savedChats.childNodes.length + 1}`;
                chatElement.addEventListener("click", () => loadChat(currentChat));
                savedChats.appendChild(chatElement);
                currentChat = [];
            }
        });

        function loadChat(chat) {
            chatBody.innerHTML = "";
            chat.forEach(({ sender, text }) => addMessage(text, sender));
        }
    </script>
</body>
</html>
